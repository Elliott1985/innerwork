# InnerWork Deployment Guide - Render

This guide walks you through deploying InnerWork to Render with PostgreSQL and Redis.

## Prerequisites

- GitHub account with InnerWork repository
- Render account (free tier available at [render.com](https://render.com))
- OpenAI API key
- Stripe API keys (test or live)

## Deployment Steps

### 1. Prepare Your Repository

Ensure all deployment files are committed to your repository:
```bash
git add render.yaml build.sh Procfile gunicorn.conf.py .env.example
git commit -m "Add Render deployment configuration"
git push origin main
```

### 2. Create Render Account

1. Go to [render.com](https://render.com) and sign up
2. Connect your GitHub account
3. Authorize Render to access your repositories

### 3. Deploy with Blueprint (Recommended)

This is the easiest method as `render.yaml` configures everything automatically:

1. Click **"New +"** → **"Blueprint"**
2. Select your `innerwork` repository
3. Render will detect `render.yaml` and show:
   - **Web Service**: `innerwork`
   - **PostgreSQL Database**: `innerwork-db`
   - **Redis Instance**: `innerwork-redis`
4. Click **"Apply"**

### 4. Configure Environment Variables

After deployment starts, go to your web service dashboard and add these **required** secrets:

#### Required Variables
- `OPENAI_API_KEY` - Your OpenAI API key (starts with `sk-`)
- `STRIPE_SECRET_KEY` - Your Stripe secret key (`sk_test_...` or `sk_live_...`)
- `STRIPE_PUBLIC_KEY` - Your Stripe publishable key (`pk_test_...` or `pk_live_...`)

#### Optional Email Variables
- `MAIL_SERVER` - SMTP server (e.g., `smtp.gmail.com`)
- `MAIL_USERNAME` - Email username
- `MAIL_PASSWORD` - Email password
- `MAIL_DEFAULT_SENDER` - Default sender email

**Note**: `FLASK_SECRET_KEY`, `DATABASE_URL`, and `REDIS_URL` are auto-generated by Render.

### 5. Monitor Deployment

1. Go to the **Logs** tab in your web service dashboard
2. Wait for the build to complete (3-5 minutes first time)
3. Look for: `Database tables created successfully`
4. Once live, you'll see: `Booting worker with pid: XXX`

### 6. Access Your Application

Your app will be available at:
```
https://innerwork.onrender.com
```
(Replace with your actual Render URL)

## Post-Deployment Setup

### Create Admin User

Use Render's Shell feature:

1. Go to your web service dashboard
2. Click **"Shell"** tab
3. Run:
```python
from app import create_app
from models import db, User

app = create_app()
with app.app_context():
    admin = User(
        username='admin',
        email='admin@innerwork.app',
        full_name='Admin User'
    )
    admin.set_password('ChangeThisPassword123!')
    db.session.add(admin)
    db.session.commit()
    print(f"Admin user created: {admin.email}")
```

### Add Initial Content

Add modules/courses using the same shell method or through your admin interface.

## Updating Your Deployment

Render automatically deploys when you push to `main`:

```bash
git add .
git commit -m "Update application"
git push origin main
```

Render will:
1. Run `build.sh` (install dependencies, migrate database)
2. Restart with new code
3. Zero-downtime deployment

## Troubleshooting

### Build Fails

**Check Python version**:
- Render uses Python 3.11 by default
- Add `runtime.txt` if you need a specific version:
```
python-3.11.5
```

**Database connection errors**:
- Verify `DATABASE_URL` is set in environment variables
- Check PostgreSQL instance is running

### Session Issues

**Redis connection errors**:
- Verify `REDIS_URL` is set correctly
- Check Redis instance is running
- View logs in Redis dashboard

### Missing Environment Variables

Go to web service → **Environment** → Add missing variables → **Save Changes**

### Chatbot Not Working

- Verify `OPENAI_API_KEY` is set correctly
- Check OpenAI API quota/billing
- Review logs for error messages

### Stripe Checkout Fails

- Verify both `STRIPE_SECRET_KEY` and `STRIPE_PUBLIC_KEY` are set
- Ensure keys match (both test or both live, not mixed)
- Check Stripe dashboard for webhook configuration

## Cost Estimate (Render Free Tier)

- **Web Service**: Free (750 hours/month, sleeps after inactivity)
- **PostgreSQL**: Free (90 days, then $7/month)
- **Redis**: Free (25MB, expires after 90 days)

**Production Recommendation**: Upgrade to paid tiers for:
- No sleep on web service ($7/month)
- Persistent PostgreSQL ($7/month)
- Persistent Redis ($10/month)

**Total Production Cost**: ~$24/month

## Security Checklist

- [ ] Change default admin password
- [ ] Use live Stripe keys (not test keys) for production
- [ ] Enable 2FA on Render account
- [ ] Set up custom domain with HTTPS (automatic on Render)
- [ ] Configure Stripe webhooks for production
- [ ] Review and restrict CORS settings if needed
- [ ] Enable database backups (paid plan)
- [ ] Set up monitoring/alerting

## Custom Domain Setup

1. Go to web service → **Settings** → **Custom Domain**
2. Add your domain (e.g., `innerwork.app`)
3. Update DNS records as shown by Render
4. Render automatically provisions SSL certificate

## Scaling

**Horizontal Scaling**:
- Increase instance count in service settings
- Redis sessions support multiple instances

**Vertical Scaling**:
- Upgrade to larger instance types
- Increase database storage/memory

## Support

- **Render Docs**: [render.com/docs](https://render.com/docs)
- **Render Community**: [community.render.com](https://community.render.com)
- **InnerWork Issues**: GitHub repository issues

## Alternative Deployment (Manual)

If you prefer not to use Blueprint:

### Manual Setup Steps

1. **Create PostgreSQL Database**
   - New → PostgreSQL
   - Name: `innerwork-db`
   - Free plan

2. **Create Redis Instance**
   - New → Redis
   - Name: `innerwork-redis`
   - Free plan

3. **Create Web Service**
   - New → Web Service
   - Connect repository
   - Name: `innerwork`
   - Build Command: `./build.sh`
   - Start Command: `gunicorn app:app`
   - Add all environment variables manually
   - Link database and Redis

This method requires more manual configuration but gives you more control.
